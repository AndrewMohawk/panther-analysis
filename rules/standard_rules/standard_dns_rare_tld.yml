AnalysisType: rule
Filename: standard_dns_rare_tld.py
RuleID: "Standard.DNS.RareTLD"
DisplayName: "DNS request Rare TLD"
Enabled: false
LogTypes:
  - Crowdstrike.FDREvent
Tags:
  - Crowdstrike
  - Initial Access:Phishing
  - Configuration Required
Severity: Critical
Description: A DNS request was made with a rare TLD
Reference: https://docs.runpanther.io/data-onboarding/supported-logs/crowdstrike#crowdstrike-dnsrequest
Runbook: Filter for host ID in title in Crowdstrike Host Management console to identify the system that queried the domain.
DedupPeriodMinutes: 15
Tests:
  - Name: Rare TLD (FDREvent)
    ExpectedResult: true
    Log:
        {
        "ConfigBuild": "1007.3.0016606.11",
        "ConfigStateHash": "1331552299",
        "ContextProcessId": "21866918",
        "ContextThreadId": "43270698197",
        "ContextTimeStamp": "2023-04-23 18:50:03.172",
        "Entitlements": "15",
        "aid": "877761efa8db44d792ddc2redacted",
        "aip": "1.1.1.1",
        "cid": "cfe698690964434083fecdredacted",
        "event": {
            "ConfigBuild": "1007.3.0016606.11",
            "ConfigStateHash": "1331552299",
            "ContextProcessId": "21866918",
            "ContextThreadId": "43270698197",
            "ContextTimeStamp": "1682275803.172",
            "DnsRequestCount": "1",
            "DomainName": "example.com.gi.",
            "DualRequest": "0",
            "EffectiveTransmissionClass": "3",
            "Entitlements": "15",
            "EventOrigin": "1",
            "InterfaceIndex": "0",
            "QueryStatus": "9003",
            "RequestType": "1",
            "aid": "877761efa8db44d792ddc2redacted",
            "aip": "1.1.1.1",
            "cid": "cfe698690964434083fecdredacted",
            "event_platform": "Win",
            "event_simpleName": "DnsRequest",
            "id": "4f006a14-0fdf-474e-bfca-021a00a935ad",
            "name": "DnsRequestV4",
            "timestamp": "1682275805712"
        },
        "event_platform": "Win",
        "event_simpleName": "DnsRequest",
        "fdr_event_type": "DnsRequest",
        "id": "4f006a14-0fdf-474e-bfca-021a00a935ad",
        "name": "DnsRequestV4",
        "p_event_time": "2023-04-23 18:50:03.172",
        "p_log_type": "Crowdstrike.FDREvent",
        "timestamp": "2023-04-23 18:50:05.712"
       }
  - Name: Rare TLD not on list (FDREvent)
    ExpectedResult: true
    Log:
      {
        "aid": "abcdefg1234567890",
        "aip": "10.0.0.0",
        "cid": "abcdefg1234567890",
        "ConfigBuild": "1007.4.0010306.1",
        "ConfigStateHash": "156025532",
        "ContextProcessId": "289977812183778042",
        "ContextThreadId": "0",
        "ContextTimeStamp": "2020-05-24 23:50:06.989",
        "Entitlements": "15",
        "event": {
          "ConfigBuild": "1007.4.0010306.1",
          "ConfigStateHash": "156025532",
          "ContextProcessId": "289977812183778042",
          "ContextThreadId": "0",
          "ContextTimeStamp": "1590364206.989",
          "DomainName": "example.barclays",
          "Entitlements": "15",
          "RequestType": "1",
          "aid": "abcdefg1234567890",
          "aip": "10.0.0.0",
          "cid": "abcdefg1234567890",
          "event_platform": "Mac",
          "event_simpleName": "DnsRequest",
          "id": "4be06eb8-9e19-11ea-a7b0-026c15f3d8ed",
          "name": "DnsRequestMacV1",
          "timestamp": "1590364207259"
        },
        "event_platform": "Mac",
        "event_simplename": "DnsRequest",
        "fdr_event_type": "DnsRequest",
        "id": "4be06eb8-9e19-11ea-a7b0-026c15f3d8ed",
        "name": "DnsRequestMacV1",
        "p_log_type": "Crowdstrike.FDREvent",
        "timestamp": "2020-05-24 23:50:07.259"
      }       
  - Name: Common TLD (FDREvent)
    ExpectedResult: false
    Log:
      {
        "aid": "abcdefg1234567890",
        "aip": "10.0.0.0",
        "cid": "abcdefg1234567890",
        "ConfigBuild": "1007.4.0010306.1",
        "ConfigStateHash": "156025532",
        "ContextProcessId": "289977812183778042",
        "ContextThreadId": "0",
        "ContextTimeStamp": "2020-05-24 23:50:06.989",
        "Entitlements": "15",
        "event": {
          "ConfigBuild": "1007.4.0010306.1",
          "ConfigStateHash": "156025532",
          "ContextProcessId": "289977812183778042",
          "ContextThreadId": "0",
          "ContextTimeStamp": "1590364206.989",
          "DomainName": "gooddomain.com",
          "Entitlements": "15",
          "RequestType": "1",
          "aid": "abcdefg1234567890",
          "aip": "10.0.0.0",
          "cid": "abcdefg1234567890",
          "event_platform": "Mac",
          "event_simpleName": "DnsRequest",
          "id": "4be06eb8-9e19-11ea-a7b0-026c15f3d8ed",
          "name": "DnsRequestMacV1",
          "timestamp": "1590364207259"
        },
        "event_platform": "Mac",
        "event_simplename": "DnsRequest",
        "fdr_event_type": "DnsRequest",
        "id": "4be06eb8-9e19-11ea-a7b0-026c15f3d8ed",
        "name": "DnsRequestMacV1",
        "p_log_type": "Crowdstrike.FDREvent",
        "timestamp": "2020-05-24 23:50:07.259"
      }
