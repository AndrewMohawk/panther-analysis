# Top 500 TLDs from Cisco Umbrella = http://s3-us-west-1.amazonaws.com/umbrella-static/index.html
TOP_500_TLDs = [
    ("1", "com"),
    ("2", "net"),
    ("3", "googleapis.com"),
    ("4", "org"),
    ("5", "io"),
    ("6", "akadns.net"),
    ("7", "akamaiedge.net"),
    ("8", "goog"),
    ("9", "akamai.net"),
    ("10", "ms"),
    ("11", "us-east-1.amazonaws.com"),
    ("12", "co"),
    ("13", "s3.amazonaws.com"),
    ("14", "apple"),
    ("15", "tv"),
    ("16", "us"),
    ("17", "akamaized.net"),
    ("18", "cn"),
    ("19", "news"),
    ("20", "map.fastly.net"),
    ("21", "dev"),
    ("22", "me"),
    ("23", "edgekey.net"),
    ("24", "us-east-1.elb.amazonaws.com"),
    ("25", "eu"),
    ("26", "uk"),
    ("27", "de"),
    ("28", "co.uk"),
    ("29", "ru"),
    ("30", "cloud"),
    ("31", "akamaihd.net"),
    ("32", "app"),
    ("33", "gov"),
    ("34", "ai"),
    ("35", "cloudapp.net"),
    ("36", "cc"),
    ("37", "jp"),
    ("38", "info"),
    ("39", "it"),
    ("40", "google"),
    ("41", "rsc.cdn77.org"),
    ("42", "gg"),
    ("43", "edgesuite.net"),
    ("44", "mobi"),
    ("45", "us-west-2.elb.amazonaws.com"),
    ("46", "azurewebsites.net"),
    ("47", "network"),
    ("48", "fi"),
    ("49", "xyz"),
    ("50", "in"),
    ("51", "be"),
    ("52", "link"),
    ("53", "fr"),
    ("54", "media"),
    ("55", "ca"),
    ("56", "tech"),
    ("57", "edu"),
    ("58", "nl"),
    ("59", "to"),
    ("60", "biz"),
    ("61", "site"),
    ("62", "pl"),
    ("63", "id"),
    ("64", "awsglobalaccelerator.com"),
    ("65", "kr"),
    ("66", "co.jp"),
    ("67", "com.cn"),
    ("68", "eu-west-1.elb.amazonaws.com"),
    ("69", "im"),
    ("70", "cloudfunctions.net"),
    ("71", "asia"),
    ("72", "co.kr"),
    ("73", "es"),
    ("74", "fm"),
    ("75", "au"),
    ("76", "sg"),
    ("77", "com.au"),
    ("78", "br"),
    ("79", "vn"),
    ("80", "appspot.com"),
    ("81", "withgoogle.com"),
    ("82", "com.br"),
    ("83", "mx"),
    ("84", "gt"),
    ("85", "se"),
    ("86", "co.id"),
    ("87", "arpa"),
    ("88", "icu"),
    ("89", "ch"),
    ("90", "tr"),
    ("91", "my"),
    ("92", "online"),
    ("93", "live"),
    ("94", "com.tr"),
    ("95", "us-east-2.elb.amazonaws.com"),
    ("96", "com.mx"),
    ("97", "ly"),
    ("98", "s3-us-west-2.amazonaws.com"),
    ("99", "at"),
    ("100", "elasticbeanstalk.com"),
    ("101", "github.io"),
    ("102", "video"),
    ("103", "top"),
    ("104", "githubusercontent.com"),
    ("105", "eu-central-1.elb.amazonaws.com"),
    ("106", "pro"),
    ("107", "la"),
    ("108", "ph"),
    ("109", "il"),
    ("110", "s3-eu-west-1.amazonaws.com"),
    ("111", "market"),
    ("112", "pt"),
    ("113", "tw"),
    ("114", "services"),
    ("115", "co.il"),
    ("116", "cz"),
    ("117", "ir"),
    ("118", "global.ssl.fastly.net"),
    ("119", "net.in"),
    ("120", "solutions"),
    ("121", "world"),
    ("122", "herokuapp.com"),
    ("123", "no"),
    ("124", "com.my"),
    ("125", "com.vn"),
    ("126", "us-east-1.elasticbeanstalk.com"),
    ("127", "ro"),
    ("128", "s3.us-east-2.amazonaws.com"),
    ("129", "pub"),
    ("130", "sk"),
    ("131", "nz"),
    ("132", "fun"),
    ("133", "systems"),
    ("134", "life"),
    ("135", "hk"),
    ("136", "cl"),
    ("137", "pe"),
    ("138", "th"),
    ("139", "is"),
    ("140", "ae"),
    ("141", "one"),
    ("142", "health"),
    ("143", "myshopify.com"),
    ("144", "com.ph"),
    ("145", "club"),
    ("146", "ua"),
    ("147", "team"),
    ("148", "co.nz"),
    ("149", "dk"),
    ("150", "host"),
    ("151", "co.in"),
    ("152", "ie"),
    ("153", "click"),
    ("154", "com.tw"),
    ("155", "gr"),
    ("156", "hu"),
    ("157", "ar"),
    ("158", "ee"),
    ("159", "am"),
    ("160", "co.th"),
    ("161", "org.cn"),
    ("162", "space"),
    ("163", "chat"),
    ("164", "ws"),
    ("165", "com.ar"),
    ("166", "dyndns.org"),
    ("167", "bid"),
    ("168", "shop"),
    ("169", "s3.dualstack.eu-west-1.amazonaws.com"),
    ("170", "store"),
    ("171", "workers.dev"),
    ("172", "com.co"),
    ("173", "s3.eu-central-1.amazonaws.com"),
    ("174", "com.hk"),
    ("175", "s3.dualstack.us-east-1.amazonaws.com"),
    ("176", "com.sg"),
    ("177", "pw"),
    ("178", "digital"),
    ("179", "jobs"),
    ("180", "blogspot.com"),
    ("181", "so"),
    ("182", "sh"),
    ("183", "art"),
    ("184", "edu.cn"),
    ("185", "ac"),
    ("186", "co.za"),
    ("187", "vip"),
    ("188", "onion"),
    ("189", "science"),
    ("190", "re"),
    ("191", "us-west-1.elb.amazonaws.com"),
    ("192", "pk"),
    ("193", "bg"),
    ("194", "ge"),
    ("195", "school"),
    ("196", "si"),
    ("197", "software"),
    ("198", "st"),
    ("199", "lv"),
    ("200", "today"),
    ("201", "games"),
    ("202", "sbs"),
    ("203", "ne.jp"),
    ("204", "sa"),
    ("205", "tk"),
    ("206", "com.ua"),
    ("207", "lt"),
    ("208", "li"),
    ("209", "website"),
    ("210", "bz"),
    ("211", "support"),
    ("212", "uno"),
    ("213", "kz"),
    ("214", "by"),
    ("215", "ad"),
    ("216", "lu"),
    ("217", "fyi"),
    ("218", "bi"),
    ("219", "firebaseapp.com"),
    ("220", "org.uk"),
    ("221", "pages.dev"),
    ("222", "do"),
    ("223", "tools"),
    ("224", "works"),
    ("225", "rs"),
    ("226", "work"),
    ("227", "zone"),
    ("228", "ec"),
    ("229", "s3-external-1.amazonaws.com"),
    ("230", "gl"),
    ("231", "al"),
    ("232", "cr"),
    ("233", "hr"),
    ("234", "run.app"),
    ("235", "uc.r.appspot.com"),
    ("236", "a.run.app"),
    ("237", "nu"),
    ("238", "email"),
    ("239", "web.app"),
    ("240", "mil"),
    ("241", "ag"),
    ("242", "global"),
    ("243", "gov.uk"),
    ("244", "rocks"),
    ("245", "ng"),
    ("246", "com.pe"),
    ("247", "guru"),
    ("248", "cdn.digitaloceanspaces.com"),
    ("249", "hn"),
    ("250", "com.pk"),
    ("251", "eg"),
    ("252", "aws"),
    ("253", "studio"),
    ("254", "uz"),
    ("255", "md"),
    ("256", "run"),
    ("257", "page"),
    ("258", "delivery"),
    ("259", "house"),
    ("260", "s3-us-west-1.amazonaws.com"),
    ("261", "lol"),
    ("262", "name"),
    ("263", "com.ec"),
    ("264", "fastlylb.net"),
    ("265", "lk"),
    ("266", "ma"),
    ("267", "ke"),
    ("268", "co.cr"),
    ("269", "ap-southeast-1.elb.amazonaws.com"),
    ("270", "uy"),
    ("271", "ac.uk"),
    ("272", "com.bd"),
    ("273", "fox"),
    ("274", "int"),
    ("275", "plus"),
    ("276", "ap-northeast-1.elb.amazonaws.com"),
    ("277", "stream"),
    ("278", "co.ke"),
    ("279", "management"),
    ("280", "ve"),
    ("281", "com.ng"),
    ("282", "ba"),
    ("283", "ninja"),
    ("284", "pics"),
    ("285", "az"),
    ("286", "technology"),
    ("287", "s3-ap-southeast-1.amazonaws.com"),
    ("288", "com.uy"),
    ("289", "sx"),
    ("290", "sc"),
    ("291", "com.eg"),
    ("292", "cat"),
    ("293", "monster"),
    ("294", "ga"),
    ("295", "wpenginepowered.com"),
    ("296", "cf"),
    ("297", "vc"),
    ("298", "pa"),
    ("299", "gov.cn"),
    ("300", "biz.id"),
    ("301", "ml"),
    ("302", "as"),
    ("303", "com.pa"),
    ("304", "blog"),
    ("305", "net.id"),
    ("306", "su"),
    ("307", "gov.hk"),
    ("308", "bet"),
    ("309", "qa"),
    ("310", "gov.in"),
    ("311", "cy"),
    ("312", "box"),
    ("313", "watch"),
    ("314", "com.gt"),
    ("315", "win"),
    ("316", "ps"),
    ("317", "design"),
    ("318", "buzz"),
    ("319", "cx"),
    ("320", "us-west-2.elasticbeanstalk.com"),
    ("321", "com.sa"),
    ("322", "events"),
    ("323", "s3.eu-west-2.amazonaws.com"),
    ("324", "gov.tw"),
    ("325", "tm"),
    ("326", "netlify.app"),
    ("327", "gov.br"),
    ("328", "press"),
    ("329", "gov.tr"),
    ("330", "com.do"),
    ("331", "map.fastlylb.net"),
    ("332", "casa"),
    ("333", "eu.org"),
    ("334", "com.pl"),
    ("335", "agency"),
    ("336", "ug"),
    ("337", "gitlab.io"),
    ("338", "cm"),
    ("339", "co.ve"),
    ("340", "cfd"),
    ("341", "xxx"),
    ("342", "ink"),
    ("343", "sb"),
    ("344", "build"),
    ("345", "gs"),
    ("346", "com.cy"),
    ("347", "tn"),
    ("348", "py"),
    ("349", "vercel.app"),
    ("350", "gh"),
    ("351", "iq"),
    ("352", "eu-west-2.elb.amazonaws.com"),
    ("353", "mg"),
    ("354", "com.py"),
    ("355", "mk"),
    ("356", "codes"),
    ("357", "tt"),
    ("358", "vg"),
    ("359", "menu"),
    ("360", "gob.mx"),
    ("361", "sky"),
    ("362", "com.gh"),
    ("363", "pr"),
    ("364", "co.uz"),
    ("365", "sv"),
    ("366", "bo"),
    ("367", "go.jp"),
    ("368", "om"),
    ("369", "aero"),
    ("370", "mu"),
    ("371", "kg"),
    ("372", "mn"),
    ("373", "com.np"),
    ("374", "ltd"),
    ("375", "ac.id"),
    ("376", "tz"),
    ("377", "duckdns.org"),
    ("378", "tl"),
    ("379", "cu"),
    ("380", "yt"),
    ("381", "com.mm"),
    ("382", "go.id"),
    ("383", "ls"),
    ("384", "net.cn"),
    ("385", "co.tz"),
    ("386", "group"),
    ("387", "ddns.net"),
    ("388", "ci"),
    ("389", "lb"),
    ("390", "mt"),
    ("391", "com.ru"),
    ("392", "gy"),
    ("393", "co.ug"),
    ("394", "com.sv"),
    ("395", "go.th"),
    ("396", "com.pr"),
    ("397", "gob.pe"),
    ("398", "zw"),
    ("399", "net.uk"),
    ("400", "freetls.fastly.net"),
    ("401", "kw"),
    ("402", "co.zw"),
    ("403", "com.kh"),
    ("404", "nhs.uk"),
    ("405", "dz"),
    ("406", "af"),
    ("407", "best"),
    ("408", "ni"),
    ("409", "ki"),
    ("410", "com.es"),
    ("411", "sn"),
    ("412", "net.au"),
    ("413", "com.mt"),
    ("414", "na"),
    ("415", "et"),
    ("416", "ao"),
    ("417", "jo"),
    ("418", "com.bo"),
    ("419", "ap-south-1.elb.amazonaws.com"),
    ("420", "nf"),
    ("421", "com.kw"),
    ("422", "com.ni"),
    ("423", "wiki"),
    ("424", "bs"),
    ("425", "ht"),
    ("426", "ap-northeast-2.elb.amazonaws.com"),
    ("427", "llc"),
    ("428", "bw"),
    ("429", "pn"),
    ("430", "mn.us"),
    ("431", "rw"),
    ("432", "ne"),
    ("433", "com.lb"),
    ("434", "com.qa"),
    ("435", "nyc3.digitaloceanspaces.com"),
    ("436", "cyou"),
    ("437", "bh"),
    ("438", "dj"),
    ("439", "gov.au"),
    ("440", "com.jm"),
    ("441", "download"),
    ("442", "com.bz"),
    ("443", "cd"),
    ("444", "je"),
    ("445", "dm"),
    ("446", "mz"),
    ("447", "dattolocal.net"),
    ("448", "jus.br"),
    ("449", "com.om"),
    ("450", "radio"),
    ("451", "mv"),
    ("452", "com.na"),
    ("453", "bn"),
    ("454", "co.bw"),
    ("455", "tj"),
    ("456", "zm"),
    ("457", "sm"),
    ("458", "com.af"),
    ("459", "co.mz"),
    ("460", "co.ao"),
    ("461", "vu"),
    ("462", "com.vc"),
    ("463", "in.th"),
    ("464", "gle"),
    ("465", "com.bh"),
    ("466", "com.pg"),
    ("467", "gi"),
    ("468", "co.ma"),
    ("469", "gov.ph"),
    ("470", "com.bn"),
    ("471", "cam"),
    ("472", "vi"),
    ("473", "fj"),
    ("474", "co.zm"),
    ("475", "s3.ap-south-1.amazonaws.com"),
    ("476", "gm"),
    ("477", "com.et"),
    ("478", "mw"),
    ("479", "cv"),
    ("480", "sl"),
    ("481", "com.ag"),
    ("482", "com.fj"),
    ("483", "bj"),
    ("484", "tg"),
    ("485", "bf"),
    ("486", "bt"),
    ("487", "nr"),
    ("488", "tf"),
    ("489", "business"),
    ("490", "com.ly"),
    ("491", "bio"),
    ("492", "co.vi"),
    ("493", "gp"),
    ("494", "sr"),
    ("495", "co.ls"),
    ("496", "ac.jp"),
    ("497", "cg"),
    ("498", "edu.au"),
    ("499", "com.gi"),
    ("500", "ca.us"),
]

# Rank threshold before alerting. Max: 500
THRESHOLD = 10

COUNTER = 0
MATCH = False

def rule(event):
    global COUNTER
    global MATCH

    COUNTER = 0
    MATCH = False

    if not event.udm("dns_query"):
        return False

    for tld in TOP_500_TLDs:
        domain = event.udm("dns_query")

        if domain.endswith(tld[1]):
            MATCH = True
            break
        COUNTER += 1

    # If match is found, then check if the rank is above the threshold
    if MATCH:
        return bool(int(list(TOP_500_TLDs[COUNTER])[0]) > THRESHOLD)

    # If no match is found, then it is beyond the threshold
    return True


def title(event):
    if MATCH:
        domain = list(TOP_500_TLDs[COUNTER])[1]
        rank = list(TOP_500_TLDs[COUNTER])[0]
    else:
        domain = event.udm("dns_query").split(".")[-1]
        rank = "N/A"
    return (
        "A DNS request was made with a rare TLD "
        + f"[{domain} - rank: {rank}] "
        + f"queried by host {event.get('aid')}"
    )
